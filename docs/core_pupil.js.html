<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/pupil.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BlinkDetector.html">BlinkDetector</a></li><li><a href="ClmGaze.html">ClmGaze</a><ul class='methods'><li data-type='method'><a href="ClmGaze.html#getEyePatches">getEyePatches</a></li><li data-type='method'><a href="ClmGaze.html#getEyePatches">getEyePatches</a></li></ul></li><li><a href="DebugBox.html">DebugBox</a><ul class='methods'><li data-type='method'><a href="DebugBox.html#addButton">addButton</a></li><li data-type='method'><a href="DebugBox.html#addButton">addButton</a></li><li data-type='method'><a href="DebugBox.html#inc">inc</a></li><li data-type='method'><a href="DebugBox.html#inc">inc</a></li><li data-type='method'><a href="DebugBox.html#set">set</a></li><li data-type='method'><a href="DebugBox.html#set">set</a></li><li data-type='method'><a href="DebugBox.html#show">show</a></li><li data-type='method'><a href="DebugBox.html#show">show</a></li></ul></li><li><a href="LinearReg.html">LinearReg</a><ul class='methods'><li data-type='method'><a href="LinearReg.html#addData">addData</a></li><li data-type='method'><a href="LinearReg.html#addData">addData</a></li><li data-type='method'><a href="LinearReg.html#getData">getData</a></li><li data-type='method'><a href="LinearReg.html#getData">getData</a></li><li data-type='method'><a href="LinearReg.html#predict">predict</a></li><li data-type='method'><a href="LinearReg.html#predict">predict</a></li><li data-type='method'><a href="LinearReg.html#setData">setData</a></li><li data-type='method'><a href="LinearReg.html#setData">setData</a></li></ul></li><li><a href="module-TrackingjsGaze.html">TrackingjsGaze</a><ul class='methods'><li data-type='method'><a href="module-TrackingjsGaze.html#detectEyes">detectEyes</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#detectEyes">detectEyes</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#detectFace">detectFace</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#detectFace">detectFace</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#findLargestRectangle">findLargestRectangle</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#findLargestRectangle">findLargestRectangle</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#getEyePatches">getEyePatches</a></li><li data-type='method'><a href="module-TrackingjsGaze.html#getEyePatches">getEyePatches</a></li></ul></li><li><a href="RidgeReg.html">RidgeReg</a><ul class='methods'><li data-type='method'><a href="RidgeReg.html#addData">addData</a></li><li data-type='method'><a href="RidgeReg.html#addData">addData</a></li><li data-type='method'><a href="RidgeReg.html#getData">getData</a></li><li data-type='method'><a href="RidgeReg.html#getData">getData</a></li><li data-type='method'><a href="RidgeReg.html#predict">predict</a></li><li data-type='method'><a href="RidgeReg.html#predict">predict</a></li><li data-type='method'><a href="RidgeReg.html#setData">setData</a></li><li data-type='method'><a href="RidgeReg.html#setData">setData</a></li></ul></li><li><a href="RidgeWightedReg.html">RidgeWightedReg</a><ul class='methods'><li data-type='method'><a href="RidgeWightedReg.html#addData">addData</a></li><li data-type='method'><a href="RidgeWightedReg.html#addData">addData</a></li><li data-type='method'><a href="RidgeWightedReg.html#getData">getData</a></li><li data-type='method'><a href="RidgeWightedReg.html#getData">getData</a></li><li data-type='method'><a href="RidgeWightedReg.html#predict">predict</a></li><li data-type='method'><a href="RidgeWightedReg.html#predict">predict</a></li><li data-type='method'><a href="RidgeWightedReg.html#setData">setData</a></li><li data-type='method'><a href="RidgeWightedReg.html#setData">setData</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-Js_objectdetectGaze.html">Js_objectdetectGaze</a><ul class='methods'><li data-type='method'><a href="module-Js_objectdetectGaze.html#detectEyes">detectEyes</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#detectEyes">detectEyes</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#detectFace">detectFace</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#detectFace">detectFace</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#findLargestRectangle">findLargestRectangle</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#findLargestRectangle">findLargestRectangle</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#getEyePatches">getEyePatches</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#getEyePatches">getEyePatches</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#mergeRectangles">mergeRectangles</a></li><li data-type='method'><a href="module-Js_objectdetectGaze.html#mergeRectangles">mergeRectangles</a></li></ul></li><li><a href="module-RidgeThreadedReg.html">RidgeThreadedReg</a><ul class='methods'><li data-type='method'><a href="module-RidgeThreadedReg.html#addData">addData</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#addData">addData</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#getData">getData</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#getData">getData</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#predict">predict</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#predict">predict</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#setData">setData</a></li><li data-type='method'><a href="module-RidgeThreadedReg.html#setData">setData</a></li></ul></li><li><a href="module-webgazer.html">webgazer</a><ul class='methods'><li data-type='method'><a href="module-webgazer.html#.getEventTypes">getEventTypes</a></li><li data-type='method'><a href="module-webgazer.html#.getEventTypes">getEventTypes</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#bound">bound</a></li><li><a href="global.html#DataWindow">DataWindow</a></li><li><a href="global.html#equalizeHistogram">equalizeHistogram</a></li><li><a href="global.html#Eye">Eye</a></li><li><a href="global.html#getCurrentFixationIndex">getCurrentFixationIndex</a></li><li><a href="global.html#getEyeFeats">getEyeFeats</a></li><li><a href="global.html#getMatrix">getMatrix</a></li><li><a href="global.html#getPupils">getPupils</a></li><li><a href="global.html#getSinglePupil">getSinglePupil</a></li><li><a href="global.html#getSubMatrix">getSubMatrix</a></li><li><a href="global.html#getSumTable">getSumTable</a></li><li><a href="global.html#getValue">getValue</a></li><li><a href="global.html#grayscale">grayscale</a></li><li><a href="global.html#KalmanFilter">KalmanFilter</a></li><li><a href="global.html#LUDecomposition">LUDecomposition</a></li><li><a href="global.html#mult">mult</a></li><li><a href="global.html#QRDecomposition">QRDecomposition</a></li><li><a href="global.html#resizeEye">resizeEye</a></li><li><a href="global.html#retrain">retrain</a></li><li><a href="global.html#ridge">ridge</a></li><li><a href="global.html#transpose">transpose</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">core/pupil.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//TODO: pupil should be inside an eye object, uh uh (it's not a joke !)
//TODO: no pupil ctor !?

import * as Utils from "../utils/util"

/**
 * Contains methods which detect the center of an eye's pupil
 * @alias module:pupil
 * @exports pupil
 */
/**
 * Returns intensity value at x,y position of a pixels image
 * @param {Array} pixels - array of size width*height
 * @param {Number} x -  input x value
 * @param {Number} y - input y value
 * @param {Number} width - width of pixels image
 * @returns {Number} - intensity value in [0,255]
 */
export function getValue(pixels, x, y, width) {
    return pixels[y * width + x];
}

/**
 * Computes summation area table/integral image of a pixel matrix
 * @param {Array} pixels value of eye area
 * @param {Number} width - of image in 'pixels'
 * @param {Number} height - of image in 'pixels'
 * @returns {Array} - integral image
 */
export function getSumTable(pixels, width, height) {
    var integralImage = new Array(width);
    var sumx          = 0;
    var sumy          = 0;

    for (var i = 0; i &lt; width; i++) {
        integralImage[i]    = new Array(height);
        sumx += getValue(pixels, i, 0, width);
        integralImage[i][0] = sumx;
    }

    for (var i = 0; i &lt; height; i++) {
        sumy += getValue(pixels, 0, i, width);
        integralImage[0][i] = sumy;
    }

    for (var x = 1; x &lt; width; x++) {
        for (var y = 1; y &lt; height; y++) {
            integralImage[x][y] = getValue(pixels, x, y, width) + integralImage[x - 1][y] + integralImage[x][y - 1] - integralImage[x - 1][y - 1];
        }
    }
    return integralImage;
}

/**
 * Detects a pupil in a set of pixels
 * @param  {Array} pixels - patch of pixels to look for pupil into
 * @param  {Number} width  - of pixel patch
 * @param  {Number} height - of pixel patch
 * @return {Array} coordinate of the bottom right corner and width of the best fitted pupil
 */
export function getSinglePupil(pixels, width, height) {
    var summedAreaTable = getSumTable(pixels, width, height);
    var bestAvgScore    = 999999; //want to minimize this score
    var bestPoint       = [0, 0]; //bottom right corner of best fitted pupil
    var bestHalfWidth   = 0; //corresponding half width of the best fitted pupil
    var offset          = Math.floor(width / 10.0); //padding
    //halfWidth could also start at 1, but this makes it faster
    for (var halfWidth = Math.floor(height / 10.0); halfWidth &lt; width / 2; halfWidth++) {
        //think of a sliding rectangular window of width halfWidth*2 that goes through the whole eye pixel matrix and does the following:
        //1) computes the irisArea, which is the total intensity of the iris
        //2) computes the scleraIrisArea, which is multiple rows of pixels including the sclera and iris.
        //3) computes avg, which is the intensity of the area divided by the number of pixels.
        //start at the bottom right of the rectangle!not top left
        for (var x = halfWidth; x &lt; width - offset; x++) {
            for (var y = halfWidth; y &lt; height - offset; y++) {
                //evaluate area by the formula found on wikipedia about the summed area table: I(D)+I(A)-I(B)-I(C)
                var irisArea       = summedAreaTable[x + offset][y + offset] + summedAreaTable[x + offset - halfWidth][y + offset - halfWidth] - summedAreaTable[x + offset][y + offset - halfWidth] - summedAreaTable[x + offset - halfWidth][y + offset];
                var avgScore       = 1.0 * irisArea / ((halfWidth + 1) * (halfWidth + 1)) + 1;
                //summation area table again
                var scleraIrisArea = ((1.0 * summedAreaTable[width - 1 - offset][y + offset] + summedAreaTable[0 + offset][y + offset - halfWidth] - summedAreaTable[0 + offset][y + offset] - summedAreaTable[width - 1 - offset][y + offset - halfWidth]) - irisArea);
                //minimize avgScore/scleraIrisArea. 150 is too high, might have to change since it's closer to white
                if ((avgScore) / scleraIrisArea &lt; bestAvgScore &amp;&amp; avgScore &lt; 150) {
                    bestAvgScore  = (avgScore) / scleraIrisArea;
                    bestPoint     = [x + offset, y + offset];
                    bestHalfWidth = halfWidth;
                }
            }
        }
    }
    return [bestPoint, bestHalfWidth];
}

/**
 * Given an object with two eye patches it finds the location of the detected pupils
 * @param  {Object} eyesObj - left and right detected eye patches
 * @return {Object} eyesObj - updated eye patches with information about pupils' locations
 */
export function getPupils(eyesObj) {
    if (!eyesObj) {
        return eyesObj;
    }
    if (!eyesObj.left.blink) {
        eyesObj.left.pupil = getSinglePupil(Array.prototype.slice.call(Utils.grayscale(eyesObj.left.patch, eyesObj.left.width, eyesObj.left.height)), eyesObj.left.width, eyesObj.left.height);
        eyesObj.left.pupil[0][0] -= eyesObj.left.pupil[1];
        eyesObj.left.pupil[0][1] -= eyesObj.left.pupil[1];
    }
    if (!eyesObj.right.blink) {
        eyesObj.right.pupil = getSinglePupil(Array.prototype.slice.call(Utils.grayscale(eyesObj.right.patch, eyesObj.right.width, eyesObj.right.height)), eyesObj.right.width, eyesObj.right.height);
        eyesObj.right.pupil[0][0] -= eyesObj.right.pupil[1];
        eyesObj.right.pupil[0][1] -= eyesObj.right.pupil[1];
    }
    return eyesObj;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Nov 22 2016 16:59:29 GMT+0100 (Paris, Madrid) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
